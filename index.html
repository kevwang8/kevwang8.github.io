<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workout Tracker</title>
  <style>
    :root {
      --background: #121622;
      --main-box-bg: #1E2733;
      --accent-orange: #FF7043;
      --accent-light: #FFAB91;
      --text-primary: #E0E0E0;
      --text-secondary: #B0B0B0;
      --border-color: #374151;
      --button-hover: #FF5722;
      --green: #66bb6a;
      --shadow-dark: rgba(0,0,0,0.7);
      --input-bg: #2B3648;
      --input-focus-bg: #37455D;
      --entry-bg: #1F2937;
      --header-bg: #37455D;
      --calendar-bg: #2B3648;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--background);
      margin: 0;
      padding: 30px 15px; /* Slightly reduced body padding */
      display: flex;
      justify-content: center;
      min-height: 100vh;
      color: var(--text-primary);
      box-sizing: border-box;
    }

    .container {
      background: var(--main-box-bg);
      max-width: 600px; /* Kept max-width the same for calendar integrity */
      width: 100%;
      padding: 25px 35px; /* Slightly reduced container padding */
      border-radius: 12px;
      box-shadow: 0 10px 25px var(--shadow-dark);
    }

    h1, h2 {
      text-align: center;
      font-weight: 700;
      margin-bottom: 15px; /* Reduced margin */
      color: var(--accent-orange);
    }

    label {
      display: block;
      margin-top: 18px; /* Reduced margin */
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--accent-light);
    }

    input[type="date"], textarea {
      width: 100%;
      padding: 10px 14px; /* Reduced input padding */
      font-size: 0.95rem; /* Slightly smaller input font */
      border-radius: 10px;
      border: 2px solid var(--border-color);
      background: var(--input-bg);
      color: var(--text-primary);
      box-sizing: border-box;
      transition: border-color 0.3s ease, background-color 0.3s ease;
    }

    input[type="date"]:focus, textarea:focus {
      border-color: var(--accent-orange);
      outline: none;
      background: var(--input-focus-bg);
    }

    textarea {
      height: 100px; /* Reduced textarea height */
      resize: vertical;
    }

    /* General button styles - applied to main action buttons and custom file upload */
    button, .custom-file-upload {
      background: var(--accent-orange);
      border: none;
      color: white;
      font-weight: 700;
      border-radius: 12px;
      padding: 10px 18px; /* Reduced button padding */
      margin-top: 15px; /* Reduced margin */
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      font-size: 0.9rem; /* Slightly smaller button font */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-grow: 1;
      max-width: calc(33.33% - 10px); /* Adjusted for 10px gap */
      box-sizing: border-box;
      min-width: 100px; /* Reduced min-width */
    }

    button:hover, .custom-file-upload:hover {
      background: var(--button-hover);
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }

    #buttons-container {
      display: flex;
      justify-content: center;
      gap: 10px; /* Reduced gap between buttons */
      flex-wrap: wrap;
      margin-top: 18px; /* Consistent with label margin */
      margin-bottom: 15px; /* Reduced margin below buttons */
    }

    .entry {
      position: relative;
      background: var(--entry-bg);
      border: 1px solid var(--border-color);
      padding: 12px 45px 12px 14px; /* Original padding to keep space for delete button */
      margin-top: 10px;
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: 0.95rem; /* Slightly smaller text for log entries */
    }

    .entry strong {
      color: var(--text-primary);
      display: block;
      margin-bottom: 5px;
    }

    .entry div {
      line-height: 1.6;
    }

    .entry button.delete-btn {
      position: absolute;
      top: 10px; /* Adjusted position */
      right: 12px; /* Adjusted position */
      background: #90caf9;
      border: none;
      color: #0d47a1;
      cursor: pointer;
      font-size: 0.8rem;
      padding: 4px 8px; /* Slightly reduced padding */
      border-radius: 6px;
      line-height: 1;
      flex-grow: 0;
      max-width: none;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .entry button.delete-btn:hover {
      background: #f44336;
      color: white;
    }

    .month-group {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      margin-top: 18px; /* Consistent margin for groups */
    }

    #workout-log > .month-group:first-child {
        margin-top: 0;
    }

    .month-header {
      background: var(--header-bg);
      padding: 10px 20px; /* Reduced padding */
      font-weight: 700;
      font-size: 1.1rem; /* Slightly smaller font */
      color: var(--accent-light);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.3s ease;
    }

    .month-header:hover {
      background: #4A566A;
    }

    .month-header::after {
      content: "▼";
      transition: transform 0.3s ease;
      font-size: 0.9rem;
      color: var(--accent-orange);
    }

    .month-group.collapsed .month-header::after {
      transform: rotate(-90deg);
    }

    .entries {
      background: var(--calendar-bg);
      padding: 12px 20px; /* Reduced padding */
      max-height: 1000px; 
      overflow: hidden;
      transition: max-height 0.4s ease, padding 0.4s ease;
    }
    
    .month-group.collapsed .entries {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
    }

    /* Calendar Styles */
    .calendar {
      margin-bottom: 25px; /* Slightly reduced margin */
      border-radius: 12px;
      overflow: hidden;
      background: var(--calendar-bg);
      padding: 15px; /* Original padding to keep it nice */
      box-shadow: inset 0 0 8px rgba(0,0,0,0.3);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--accent-light);
      margin-bottom: 10px; /* Original margin */
    }

    .calendar-header h2 {
      font-size: 1.2rem; /* Original size */
      margin: 0;
      color: var(--text-primary);
    }

    /* Specific styles for calendar navigation buttons */
    .calendar-header button {
      /* Reverted specific values for calendar nav buttons */
      padding: 6px 12px; 
      font-size: 0.9rem;
      border-radius: 6px;
      background: #4A566A; /* Distinct background */
      box-shadow: none; /* No extra shadow */
      flex-grow: 0; /* Don't grow with other buttons */
      max-width: none; /* No max-width restriction */
      margin-top: 0; /* Remove top margin */
      min-width: unset; /* Remove min-width restriction */
    }

    .calendar-header button:hover {
      background: var(--accent-orange); /* Orange on hover */
      box-shadow: none; /* No extra shadow on hover */
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px; /* Original gap */
    }

    .calendar-day, .calendar-label {
      text-align: center;
      padding: 10px; /* Original padding */
      border-radius: 6px;
      background: var(--input-bg);
      font-size: 0.9rem; /* Original size */
      transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }

    .calendar-label {
      font-weight: bold;
      color: var(--accent-light);
      background: transparent;
    }

    .calendar-day:not(.calendar-label):hover {
      background-color: #3B4A62;
      cursor: pointer;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .calendar-day.logged {
      background: var(--green);
      color: #fff;
      font-weight: 600;
    }

    .calendar-day.today {
      outline: 2px solid #42A5F5; 
      outline-offset: -3px;
      box-shadow: 0 0 0 2px #42A5F5;
    }

    .calendar-day.selected {
      outline: 2px solid var(--accent-orange); 
      outline-offset: -3px;
      box-shadow: 0 0 0 2px var(--accent-orange);
      background: var(--accent-orange);
      color: white;
    }

    /* Success message styles */
    #success-message {
      opacity: 0;
      visibility: hidden;
      transition: opacity 1.5s ease, visibility 1.5s ease;
      font-weight: 700;
      margin-top: 15px;
      margin-bottom: 10px;
      text-align: center;
      color: var(--green);
    }

    #success-message.show {
      opacity: 1;
      visibility: visible;
    }

    #success-message.instant-show {
      transition: none !important;
      opacity: 1 !important;
      visibility: visible !important;
    }

    #import-file {
      display: none; 
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
        .container {
            padding: 20px;
        }
        h1 {
            font-size: 1.8rem;
        }
        h2 {
            font-size: 1.4rem;
        }
        #buttons-container button,
        #buttons-container .custom-file-upload {
            max-width: 100%;
        }
        .calendar-header h2 {
            font-size: 1.2rem;
        }
        /* Calendar buttons on small screens */
        .calendar-header button {
            padding: 6px 10px;
            font-size: 0.85rem;
        }
        .calendar-day, .calendar-label {
            font-size: 0.85rem;
            padding: 8px 5px;
        }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Workout Tracker</h1>

  <div class="calendar">
    <div class="calendar-header">
      <button id="prev-month" aria-label="Previous month">◀</button>
      <h2 id="calendar-title">This Month</h2>
      <button id="next-month" aria-label="Next month">▶</button>
    </div>
    <div class="calendar-grid" id="calendar-grid"></div>
  </div>

  <label for="workout-date">Date:</label>
  <input type="date" id="workout-date" />

  <label for="workout-text">Workout Details:</label>
  <textarea id="workout-text" placeholder="E.g., Squats: 3 sets x 8-10 reps @ 100kg"></textarea>

  <div id="buttons-container">
    <button id="save-btn">Save Workout</button>
    <button id="export-btn">Export Data</button>
    <input type="file" id="import-file" accept=".json" />
    <label for="import-file" class="custom-file-upload">Import Data</label>
  </div>

  <div id="success-message">Workout saved successfully!</div>


  <h2>Workout Log</h2>
  <div id="workout-log"></div>
</div>

<script>
  const today = new Date();
  let calendarMonth = today.getMonth();
  let calendarYear = today.getFullYear();

  document.getElementById("workout-date").value = today.toLocaleDateString('en-CA');

  function showSaveMessage() {
    const msgElement = document.getElementById("success-message");
    
    msgElement.classList.add("instant-show");
    msgElement.classList.add("show");
    
    requestAnimationFrame(() => {
      msgElement.classList.remove("instant-show");
    });
    
    setTimeout(() => {
      msgElement.classList.remove("show");
    }, 2000); 
  }

  function saveWorkout() {
    const date = document.getElementById("workout-date").value;
    const text = document.getElementById("workout-text").value.trim();
    if (!date || !text) {
      alert("Please enter both a date and workout details.");
      return;
    }

    const todayStr = new Date().toLocaleDateString('en-CA');
    if (date > todayStr) {
      alert("You can't log workouts for future dates.");
      return;
    }

    localStorage.setItem("workout-" + date, text);
    document.getElementById("workout-text").value = "";
    loadLog();
    renderCalendar(); 
    updateCalendarSelectionHighlight(date); 
    showSaveMessage();
  }

  function deleteWorkout(date) {
    if (!confirm(`Are you sure you want to delete the workout for ${date}?`)) {
      return;
    }
    localStorage.removeItem("workout-" + date);
    loadLog();
    renderCalendar();
    
    const currentDateInputVal = document.getElementById("workout-date").value;
    if(currentDateInputVal === date) {
        document.getElementById("workout-date").value = new Date().toLocaleDateString('en-CA');
        document.getElementById("workout-text").value = "";
        updateCalendarSelectionHighlight(document.getElementById("workout-date").value);
    }
  }

  function loadLog() {
    const log = document.getElementById("workout-log");
    log.innerHTML = "";
    const entries = [];
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith("workout-")) {
        entries.push({
          date: key.replace("workout-", ""),
          entry: localStorage.getItem(key)
        });
      }
    });
    entries.sort((a, b) => new Date(b.date) - new Date(a.date));

    const grouped = {};
    entries.forEach(({ date, entry }) => {
      const ym = date.slice(0, 7);
      if (!grouped[ym]) grouped[ym] = [];
      grouped[ym].push({ date, entry });
    });

    const currentYM = today.toLocaleDateString('en-CA').slice(0,7);

    Object.keys(grouped)
      .sort((a, b) => new Date(b + "-01") - new Date(a + "-01"))
      .forEach(ym => {
        const groupDiv = document.createElement("div");
        groupDiv.classList.add("month-group");
        if (ym !== currentYM) groupDiv.classList.add("collapsed");

        const header = document.createElement("div");
        header.classList.add("month-header");
        const [year, month] = ym.split("-");
        const displayDate = new Date(parseInt(year), parseInt(month) - 1);
        header.textContent = displayDate.toLocaleString(undefined, { year: "numeric", month: "long" });
        header.addEventListener("click", () => groupDiv.classList.toggle("collapsed"));

        const entriesDiv = document.createElement("div");
        entriesDiv.classList.add("entries");

        const summary = document.createElement("div");
        summary.textContent = `${grouped[ym].length} workout day(s) logged this month`;
        summary.style.marginBottom = "8px";
        summary.style.fontWeight = "bold";
        summary.style.color = "var(--accent-light)";
        entriesDiv.appendChild(summary);

        grouped[ym].forEach(({ date, entry }) => {
          const entryDiv = document.createElement("div");
          entryDiv.classList.add("entry");

          const strong = document.createElement("strong");
          strong.textContent = date; 
          
          const textNode = document.createElement("div");
          textNode.innerHTML = entry.replace(/\n/g, "<br>");

          const deleteBtn = document.createElement("button");
          deleteBtn.classList.add("delete-btn");
          deleteBtn.textContent = "Delete";
          deleteBtn.setAttribute('aria-label', `Delete workout for ${date}`); 
          deleteBtn.addEventListener("click", () => deleteWorkout(date));

          entryDiv.appendChild(deleteBtn);
          entryDiv.appendChild(strong);
          entryDiv.appendChild(textNode);
          entriesDiv.appendChild(entryDiv);
        });

        groupDiv.appendChild(header);
        groupDiv.appendChild(entriesDiv);
        log.appendChild(groupDiv);
      });

    if (Object.keys(grouped).length === 0) {
        const emptyStateP = document.createElement("p");
        emptyStateP.textContent = "No workouts logged yet. Add one using the form above!";
        emptyStateP.style.textAlign = "center";
        emptyStateP.style.marginTop = "15px";
        emptyStateP.style.color = "var(--text-secondary)";
        log.appendChild(emptyStateP);
    }
  }

  function renderCalendar() {
    const grid = document.getElementById("calendar-grid");
    const title = document.getElementById("calendar-title");
    grid.innerHTML = "";

    const firstDay = new Date(calendarYear, calendarMonth, 1);
    const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
    const startDayOfWeek = firstDay.getDay(); 
    const totalDays = lastDay.getDate();

    const daysOfWeek = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    daysOfWeek.forEach(dow => {
      const label = document.createElement("div");
      label.classList.add("calendar-label");
      label.textContent = dow;
      grid.appendChild(label);
    });

    for(let i = 0; i < startDayOfWeek; i++) {
      const blank = document.createElement("div");
      blank.classList.add("calendar-day");
      blank.style.background = "transparent";
      blank.style.cursor = "default";
      grid.appendChild(blank);
    }

    const currentlySelectedDate = document.getElementById("workout-date").value;

    for(let day=1; day <= totalDays; day++) {
      const dateStr = new Date(calendarYear, calendarMonth, day).toLocaleDateString('en-CA');
      const dayDiv = document.createElement("div");
      dayDiv.classList.add("calendar-day");
      dayDiv.textContent = day;

      if (localStorage.getItem("workout-" + dateStr)) {
        dayDiv.classList.add("logged");
      }
      if (dateStr === new Date().toLocaleDateString('en-CA')) {
        dayDiv.classList.add("today");
      }
      if (dateStr === currentlySelectedDate) {
        dayDiv.classList.add("selected");
      }

      dayDiv.addEventListener("click", () => {
        document.getElementById("workout-date").value = dateStr;
        
        const savedText = localStorage.getItem("workout-" + dateStr) || "";
        document.getElementById("workout-text").value = savedText;
        document.getElementById("workout-text").focus();

        document.querySelectorAll(".calendar-day.selected").forEach(el => el.classList.remove("selected"));
        dayDiv.classList.add("selected");
      });
      grid.appendChild(dayDiv);
    }
    title.textContent = firstDay.toLocaleString(undefined, { month: "long", year: "numeric" });
  }

  function handleDateInputChange(event) {
    const newSelectedDate = event.target.value;
    if (!newSelectedDate) return;

    updateCalendarSelectionHighlight(newSelectedDate);

    const savedText = localStorage.getItem("workout-" + newSelectedDate) || "";
    document.getElementById("workout-text").value = savedText;
  }

  function updateCalendarSelectionHighlight(dateStrToSelect) {
    document.querySelectorAll(".calendar-day.selected").forEach(el => el.classList.remove("selected"));
    if (!dateStrToSelect) return;

    const dateObj = new Date(dateStrToSelect + "T00:00:00"); 
    const targetYear = dateObj.getFullYear();
    const targetMonth = dateObj.getMonth(); 
    const targetDay = dateObj.getDate();

    if (targetYear === calendarYear && targetMonth === calendarMonth) {
      const calendarDays = document.querySelectorAll("#calendar-grid .calendar-day");
      let foundAndSelected = false;
      for (const dayDiv of calendarDays) {
        if (dayDiv.textContent === String(targetDay) && !dayDiv.style.background.includes("transparent")) {
          dayDiv.classList.add("selected");
          foundAndSelected = true;
          break; 
        }
      }
      if (!foundAndSelected) {
          document.querySelectorAll(".calendar-day.selected").forEach(el => el.classList.remove("selected"));
      }
    } else {
        document.querySelectorAll(".calendar-day.selected").forEach(el => el.classList.remove("selected"));
    }
  }


  document.getElementById("save-btn").addEventListener("click", saveWorkout);
  document.getElementById("workout-date").addEventListener("change", handleDateInputChange); 

  document.getElementById("export-btn").addEventListener("click", () => {
    const workouts = [];
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith("workout-")) {
        workouts.push({ date: key.replace("workout-", ""), details: localStorage.getItem(key) });
      }
    });
    workouts.sort((a, b) => new Date(a.date) - new Date(b.date));

    const json = JSON.stringify(workouts, null, 2); 

    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "workouts.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById("import-file").addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (!file) {
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const importedData = JSON.parse(e.target.result);

        if (!Array.isArray(importedData)) {
          console.error("Import error: JSON is not an array or malformed.");
          alert("Import failed: The selected file is not a valid workout JSON file."); 
          return;
        }

        if (confirm("Importing new workouts will replace existing ones. Do you want to proceed?")) {
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith("workout-")) {
                    localStorage.removeItem(key);
                }
            });

            importedData.forEach(item => {
                if (item.date && item.details) {
                    if (/^\d{4}-\d{2}-\d{2}$/.test(item.date)) {
                        localStorage.setItem("workout-" + item.date, item.details);
                    } else {
                        console.warn(`Skipping invalid date format: ${item.date} in import file.`);
                    }
                } else {
                    console.warn("Skipping malformed entry during import:", item);
                }
            });
            loadLog();
            renderCalendar();
            document.getElementById("workout-date").value = new Date().toLocaleDateString('en-CA');
            document.getElementById("workout-text").value = "";
            updateCalendarSelectionHighlight(document.getElementById("workout-date").value);
        }

      } catch (error) {
        console.error("Error parsing JSON file:", error);
        alert("Import failed: Could not read or parse the JSON file. It might be corrupted or not a valid JSON."); 
      } finally {
        event.target.value = ''; 
      }
    };
    reader.readAsText(file);
  });

  document.getElementById("prev-month").addEventListener("click", () => {
    calendarMonth--;
    if (calendarMonth < 0) {
      calendarMonth = 11;
      calendarYear--;
    }
    renderCalendar();
    updateCalendarSelectionHighlight(document.getElementById("workout-date").value);
  });

  document.getElementById("next-month").addEventListener("click", () => {
    calendarMonth++;
    if (calendarMonth > 11) {
      calendarMonth = 0;
      calendarYear++;
    }
    renderCalendar();
    updateCalendarSelectionHighlight(document.getElementById("workout-date").value);
  });

  // Initialize UI
  loadLog();
  renderCalendar();
  updateCalendarSelectionHighlight(document.getElementById("workout-date").value);
</script>
</body>
</html>
